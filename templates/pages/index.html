{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<style>
  .main {
    display: flex;
    justify-content: center;
    align-items: center;
  } 
</style>
<br>


    <div class="container-fluid py-4">

      <div class="d-flex justify-content-center mb-3">
        <div class="p-2">
          <h2>Temperatur Sensor</h2>
        </div>
      </div>
      <div class="justify-content-center mb-3">
        <div class="row mt-4 main">
        <div class="col-lg-3">
          <div class="card text-center">
          <!--
            <div class="card-body p-3">
                
                <h5>Last Measurement</h5>

                <table class="table table-sm align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-xxs font-weight-bolder opacity-7">Temperatur</th>
                      <th class="text-uppercase text-xxs font-weight-bolder opacity-7 ps-2"></th>
                      <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Date</th>
                      <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Time</th>
                      <th class="text-secondary opacity-7"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0">{{ temperature }}  °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-success">Online</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">11/10/23</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          21:00
                        </div>
                      </td>
                    </tr>
              </table>
              <br>
              <button class="btn btn-icon btn-3 btn-primary" id="setApplyBtn" type="button">
                <span class="btn-inner--icon"><i class="ni ni-button-play"></i></span>
                <span class="btn-inner--text">Pull</span>
              </button>
            </div>
          -->
          </div>
        </div>
      </div>
      </div>
      <div class="row mt-4 main">     
        <div class="col-lg-7">
          <div class="card z-index-2">
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-line" class="chart-canvas" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-2">
          <div class="card z-index-2 text-center">
            <div class="card-body p-3">
              <h3>Selection</h3>
              <form>
                <div class="form-group">
                  <label for="example-date-input" class="form-control-label">Date</label>
                  <input class="form-control" type="date" value="2023-01-01" id="example-date-input">
                </div>
                <div class="form-group">
                  <label for="example-time-input" class="form-control-label">Start Time</label>
                  <input class="form-control" type="time" value="08:00:00" id="start-time-input">
                </div>
                <div class="form-group">
                  <label for="example-time-input" class="form-control-label">End Time</label>
                  <input class="form-control" type="time" value="15:00:00" id="end-time-input">
                </div>                           
              </form>
              <button class="btn btn-icon btn-3 btn-primary" id="setApplyBtn" type="button">
                <span class="btn-inner--icon"><i class="ni ni-button-play"></i></span>
                <span class="btn-inner--text">Apply</span>
              </button>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" checked="">
                <label class="form-check-label" for="flexSwitchCheckDefault">Show Table</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <br>

      <div class="container">
        <div class="row">
          <div class="col-sm">
          </div>
          <div class="col-sm">
            <div class="card" id="temperaturDataCard" style="display: none;">
              <div class="table-responsive">
                <table class="table table-sm align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-xxs font-weight-bolder opacity-7">Temperatur</th>
                      <th class="text-uppercase text-xxs font-weight-bolder opacity-7 ps-2"></th>
                      <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Date</th>
                      <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Time</th>
                      <th class="text-secondary opacity-7"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs">24.2 °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-success">Online</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">23/04/18</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          09:52
                        </div>
                      </td>
                    </tr>
            
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs">24.2 °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-secondary">Offline</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">11/01/19</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          09:58
                        </div>
                      </td>
                    </tr>
            
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs">24.2 °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-success">Online</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">19/09/17</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          10:52
                        </div>
                      </td>
                    </tr>
            
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs">34.8 °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-success">Online</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">24/12/08</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          11:12
                        </div>
                      </td>
                    </tr>
            
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs">32.1 °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-secondary">Offline</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">04/10/21</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          12:11
                        </div>
                      </td>
                    </tr>
      
                    <br>
            
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs">26.1 °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-secondary">Offline</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">14/09/20</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          17:44
                        </div>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs">27.3 °C</h6>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm badge-secondary">Offline</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">14/09/20</span>
                      </td>
                      <td class="align-middle">
                        <div class="d-flex px-2 py-1">
                          17:44
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-sm">
          </div>
        </div>
      </div>
      {% include "includes/footer.html" %}
    </div>
{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block scripts %}

  <script src="{% static 'js/plugins/chartjs.min.js' %}"></script>
  <script>

      window.onload = function () {
          var today = new Date().toISOString().split('T')[0];
          document.getElementById('example-date-input').value = today;
          
          buttonX.click();
      };

    var ctx2 = document.getElementById("chart-line").getContext("2d");

    var gradientStroke1 = ctx2.createLinearGradient(0, 230, 0, 50);

    gradientStroke1.addColorStop(1, 'rgba(203,12,159,0.2)');
    gradientStroke1.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke1.addColorStop(0, 'rgba(203,12,159,0)'); //purple colors

    var gradientStroke2 = ctx2.createLinearGradient(0, 230, 0, 50);

    gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
    gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)'); //purple colors
    function fetchDataAndUpdateChart(chartContext) {
    fetchData()
        .then(temperatureValues => {
            console.log('Temperature Values:', temperatureValues);
            updateChartWithTemperatureValues(chartContext, temperatureValues);
        })
        .catch(error => {
            console.error('Fetch error:', error);
        });
}

const myChart = new Chart(ctx2, {
      type: "line",
      data: {
        labels: ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00"],
        datasets: [{
            label: "172.20.178.32",
            tension: 0.4,
            borderWidth: 0,
            pointRadius: 0,
            borderColor: "#cb0c9f",
            borderWidth: 3,
            backgroundColor: gradientStroke1,
            fill: true,
            data: {{ graph_data }},
            maxBarThickness: 6

          }
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              padding: 10,
              color: '#b2b9bf',
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              color: '#b2b9bf',
              padding: 20,
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
        },
      },
    });

    $("#flexSwitchCheckDefault").change(function () {
      if (this.checked) {
        $("#temperaturDataCard").show();
      } else {
        $("#temperaturDataCard").hide();
      }
    });

    function generateTimeFrameUrl(apiUrl, startDate, endDate) {
      
      var endpoint = "/v1/temperature/range";
      var params = {
          start_date: startDate,
          end_date: endDate
      };

      // Baue die vollständige URL unter Verwendung von URLSearchParams
      var url = new URL(endpoint, apiUrl);
      url.search = new URLSearchParams(params).toString();

      return url.toString();
    }

    function getTemperatureValues(jsonData) {
      console.log("hey " + jsonData)
      const dataArray = JSON.parse(jsonData);
      console.log("hey " + dataArray)
      // Check if the input is an array
      if (!Array.isArray(dataArray)) {
        throw new Error('Input is not an array');
      }

      // Extract temperature values from each object in the array
      const temperatureValues = dataArray.map(obj => obj.temperature);
      return temperatureValues;
    }

    function getTimeValues(jsonData) {
  const dataArray = JSON.parse(jsonData);

  if (!Array.isArray(dataArray)) {
    throw new Error('Input is not an array');
  }

  // Extract time values from each object in the array
  const timeValues = dataArray.map(obj => {
    const timestamp = new Date(obj.timestamp);
    const hours = timestamp.getHours();
    const minutes = timestamp.getMinutes();
    const seconds = timestamp.getSeconds();

    // Format the time as HH:MM:SS
    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    return formattedTime;
  });

  return timeValues;
}

function fetchData() {
    return new Promise((resolve, reject) => {
        // Replace 'https://api.example.com/endpoint' with your actual API endpoint
        var dateInput = document.getElementById("example-date-input").value;
        var startTimeInput = document.getElementById("start-time-input").value;
        var endTimeInput = document.getElementById("end-time-input").value;
        var baseUrl = "http://172.20.177.206:8000";
        var startDate = dateInput + "T" + startTimeInput;
        var endDate = dateInput + "T" + endTimeInput;
        const apiUrl = generateTimeFrameUrl(baseUrl, startDate, endDate);

        let data; // Declare the data variable here

        // Make a GET request to the API endpoint
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} for URL: ${apiUrl}`);
                }
                return response.json();
            })
            .then(parsedData => {
                data = parsedData; // Assign the parsed data to the variable
                // Extract time values
                const timeValues = getTimeValues(JSON.stringify(data));
                // Resolve the promise with both temperature and time values
                resolve({ temperatureValues: getTemperatureValues(JSON.stringify(data)), timeValues });
            })
            .catch(error => {
                reject(error);
            });
    });
}

    function updateChartWithTemperatureValues(chart, temperatureValues, timeValues) {
        // Update the chart's dataset with the new temperature values
        chart.data.labels = timeValues; // Update labels with timestamps
        chart.data.datasets[0].data = temperatureValues;
        chart.update();
    }

// Example usage:

      const buttonX = document.getElementById('setApplyBtn');

      // Attach the fetchData function to the button's click event
      buttonX.addEventListener('click', () => {
        fetchData()
            .then(({ temperatureValues, timeValues }) => {
                console.log('Temperature Values:', temperatureValues);
                console.log('Time Values:', timeValues);
                // Perform further actions with temperatureValues and timeValues as needed
                updateChartWithTemperatureValues(myChart, temperatureValues, timeValues);
            })
            .catch(error => {
                console.error('Fetch error:', error);
            });
    });

  </script>

{% endblock scripts %}
